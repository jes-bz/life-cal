<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Calendar Wallpaper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex flex-col">

    <!-- UI Container (Hidden if mode=image) -->
    <div id="ui-container" class="flex flex-col h-full md:flex-row">

        <!-- Controls Panel -->
        <div
            class="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col z-10 shadow-lg md:shadow-none h-auto max-h-[40vh] md:max-h-full overflow-y-auto">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-xl font-bold tracking-tighter uppercase"><i
                        class="fa-solid fa-calendar-days mr-2 text-indigo-600"></i>MEMENTO MORI</h1>
                <p class="text-xs text-gray-500 mt-1">Life Calendar Generator</p>
            </div>

            <div class="p-6 space-y-6 flex-1 overflow-y-auto">

                <!-- Date & Age -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Birth Date</label>
                        <input type="date" id="dob"
                            class="appearance-none block w-full bg-gray-50 border border-gray-200 rounded p-2 text-base focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Expectancy (Years)</label>
                        <input type="number" id="years" value="80" min="1" max="120"
                            class="appearance-none block w-full bg-gray-50 border border-gray-200 rounded p-2 text-base focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Layout Options -->
                <div class="space-y-3">
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Layout Mode</label>

                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="layout-none" name="layout" value="none"
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="layout-none" class="ml-2 block text-sm text-gray-700">Standard (Clock +
                                Buttons)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="layout-top" name="layout" value="top"
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="layout-top" class="ml-2 block text-sm text-gray-700">+ Top Widgets</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="layout-bottom" name="layout" value="bottom"
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="layout-bottom" class="ml-2 block text-sm text-gray-700">+ Bottom Widgets</label>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Colors -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Background</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="color-bg" value="#000000"
                                class="h-10 w-10 rounded cursor-pointer border-0 p-0">
                            <input type="text" id="hex-bg" value="#000000"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded p-2 text-base font-mono uppercase">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Lived Weeks</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="color-lived" value="#3b82f6"
                                class="h-10 w-10 rounded cursor-pointer border-0 p-0">
                            <input type="text" id="hex-lived" value="#3b82f6"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded p-2 text-base font-mono uppercase">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Future Weeks</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="color-rest" value="#333333"
                                class="h-10 w-10 rounded cursor-pointer border-0 p-0">
                            <input type="text" id="hex-rest" value="#333333"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded p-2 text-base font-mono uppercase">
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="pt-4 space-y-3">
                    <button id="btn-download"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded text-sm transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-download mr-2"></i> Download Wallpaper
                    </button>
                    <button id="btn-copy-link"
                        class="w-full bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded text-sm transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-link mr-2"></i> Copy Config Link
                    </button>
                    <a id="direct-link" href="#" target="_blank"
                        class="block text-center text-xs text-indigo-500 hover:underline">
                        Open Image-Only Mode
                    </a>
                </div>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="flex-1 bg-gray-200 relative overflow-hidden flex items-center justify-center p-4 md:p-8">
            <div class="relative shadow-2xl rounded-3xl border-8 border-gray-800 overflow-hidden bg-black"
                style="aspect-ratio: 1320/2868; height: 90%;">
                <!-- The Canvas is now directly displayed for performance -->
                <canvas id="canvas" width="1320" height="2868"
                    class="w-full h-full object-contain bg-transparent"></canvas>

                <!-- Phone Notch (Purely aesthetic for preview) -->
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-1/3 h-7 bg-gray-800 rounded-b-xl z-20">
                </div>
            </div>
        </div>
    </div>

    <!-- Image Mode Container (Shown only if mode=image) -->
    <div id="image-mode-container" class="hidden fixed inset-0 bg-black flex items-center justify-center">
        <img id="full-render-img" class="max-w-full max-h-full object-contain" alt="Generated Life Calendar">
    </div>

    <script>
        // --- Configuration & Constants ---
        // iPhone 16 Pro Max Resolution
        const CANVAS_WIDTH = 1320;
        const CANVAS_HEIGHT = 2868;

        // --- DOM Elements ---
        const els = {
            dob: document.getElementById('dob'),
            years: document.getElementById('years'),
            layoutRadios: document.getElementsByName('layout'),
            colorBg: document.getElementById('color-bg'),
            hexBg: document.getElementById('hex-bg'),
            colorLived: document.getElementById('color-lived'),
            hexLived: document.getElementById('hex-lived'),
            colorRest: document.getElementById('color-rest'),
            hexRest: document.getElementById('hex-rest'),
            canvas: document.getElementById('canvas'),
            fullRenderImg: document.getElementById('full-render-img'),
            btnDownload: document.getElementById('btn-download'),
            btnCopy: document.getElementById('btn-copy-link'),
            directLink: document.getElementById('direct-link'),
            uiContainer: document.getElementById('ui-container'),
            imageContainer: document.getElementById('image-mode-container'),
        };

        // --- State ---
        let state = {
            dob: '1990-01-01',
            years: 90,
            bg: '#000000',
            lived: '#ffffff',
            rest: '#333333',
            layout: 'none', // 'none', 'top', 'bottom'
            mode: 'interactive'
        };

        // --- Initialization ---
        function init() {
            // 1. Parse URL Params
            const params = new URLSearchParams(window.location.search);

            if (params.has('dob')) state.dob = params.get('dob');
            if (params.has('years')) state.years = parseInt(params.get('years'));
            if (params.has('bg')) state.bg = '#' + params.get('bg').replace('#', '');
            if (params.has('lived')) state.lived = '#' + params.get('lived').replace('#', '');
            if (params.has('rest')) state.rest = '#' + params.get('rest').replace('#', '');

            // Layout
            if (params.has('layout')) state.layout = params.get('layout');

            if (params.get('mode') === 'image') state.mode = 'image';

            // 2. Set Input Values
            els.dob.value = state.dob;
            els.years.value = state.years;

            // Set radio
            const radio = document.querySelector(`input[name="layout"][value="${state.layout}"]`);
            if (radio) radio.checked = true;

            updateColorInputs('bg', state.bg);
            updateColorInputs('lived', state.lived);
            updateColorInputs('rest', state.rest);

            // 3. Check Mode
            if (state.mode === 'image') {
                els.uiContainer.classList.add('hidden');
                els.imageContainer.classList.remove('hidden');
            } else {
                // Initialize the direct link href immediately
                updateUrl();
            }

            // Draw immediately
            draw();

            // 4. Listeners
            addListeners();
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Debounce to prevent flooding history API
        const debouncedUpdateUrl = debounce(updateUrl, 300);

        function addListeners() {
            // Inputs
            const inputs = ['dob', 'years'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    state[id] = e.target.value;
                    debouncedUpdateUrl();
                    draw();
                });
            });

            // Layout Radios
            els.layoutRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        state.layout = e.target.value;
                        debouncedUpdateUrl();
                        draw();
                    }
                });
            });

            // Color Pickers
            setupColorSync('bg');
            setupColorSync('lived');
            setupColorSync('rest');

            // Buttons
            els.btnDownload.addEventListener('click', downloadImage);
            els.btnCopy.addEventListener('click', copyLink);
        }

        function setupColorSync(key) {
            const picker = document.getElementById(`color-${key}`);
            const text = document.getElementById(`hex-${key}`);

            picker.addEventListener('input', (e) => {
                text.value = e.target.value;
                state[key] = e.target.value;
                debouncedUpdateUrl();
                draw();
            });

            text.addEventListener('input', (e) => {
                let val = e.target.value;
                if (!val.startsWith('#')) val = '#' + val;
                if (/^#[0-9A-F]{6}$/i.test(val)) {
                    picker.value = val;
                    state[key] = val;
                    debouncedUpdateUrl();
                    draw();
                }
            });
        }

        function updateColorInputs(key, val) {
            document.getElementById(`color-${key}`).value = val;
            document.getElementById(`hex-${key}`).value = val;
        }

        // --- Core Logic ---

        function getWeeksLived(dob) {
            const birth = new Date(dob);
            const now = new Date();
            const diffTime = Math.abs(now - birth);
            const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
            return diffWeeks;
        }

        function draw() {
            const ctx = els.canvas.getContext('2d');
            const width = CANVAS_WIDTH;
            const height = CANVAS_HEIGHT;

            // Fill Background
            ctx.fillStyle = state.bg;
            ctx.fillRect(0, 0, width, height);

            if (!state.dob) return;

            const totalYears = parseInt(state.years) || 90;
            const totalWeeks = totalYears * 52;
            const livedWeeks = getWeeksLived(state.dob);

            // Safe Zones calculation
            const BASE_TOP_PCT = 0.25; // Clock area
            const BASE_BOTTOM_PCT = 0.10; // Buttons area

            // Differentiate top/bottom widget spacing
            const TOP_WIDGET_ADDITION = 0.10;
            const BOTTOM_WIDGET_ADDITION = 0.10;

            let topPct = BASE_TOP_PCT;
            let bottomPct = BASE_BOTTOM_PCT;

            if (state.layout === 'top') {
                topPct += TOP_WIDGET_ADDITION;
            } else if (state.layout === 'bottom') {
                bottomPct += BOTTOM_WIDGET_ADDITION;
            }

            const safeZoneTop = height * topPct;
            const safeZoneBottom = height * bottomPct;

            const marginX = width * 0.04;
            const availableWidth = width - (marginX * 2);

            // Gap between cells
            const gap = 5;

            // Calculate optimal columns

            // Find the minimum columns needed to fit vertically
            let minFitCols = 0;
            let c = 52;

            // Safety break at 200
            while (c < 200) {
                const cellSize = (availableWidth - (gap * (c - 1))) / c;
                const rows = Math.ceil(totalWeeks / c);
                const gridHeight = (cellSize * rows) + (gap * (rows - 1));

                const extraTopH = 5 * (cellSize + gap);
                const extraBottomH = 6 * (cellSize + gap);

                const requiredHeight = gridHeight + extraTopH + extraBottomH;
                const availableHeight = height - safeZoneTop - safeZoneBottom;

                if (requiredHeight <= availableHeight + 1) {
                    minFitCols = c;
                    break;
                }
                c++;
            }

            // Use minFitCols to set final parameters
            const cols = minFitCols;
            const cellSize = (availableWidth - (gap * (cols - 1))) / cols;
            const rows = Math.ceil(totalWeeks / cols);
            const gridHeight = (cellSize * rows) + (gap * (rows - 1));
            const extraTopH = 0 * (cellSize + gap);
            const extraBottomH = 0 * (cellSize + gap);

            // Final Dimensions
            const finalGridWidth = (cellSize * cols) + (gap * (cols - 1));

            // Positioning
            // Top Y = SafeZoneTop + 5 rows clearance + Centering Offset
            const startY = (safeZoneTop + extraTopH);

            // Center Horizontally
            const startX = (width - finalGridWidth) / 2;

            let currentWeek = 0;

            for (let i = 0; i < totalWeeks; i++) {
                currentWeek++;

                const colIndex = i % cols;
                const rowIndex = Math.floor(i / cols);

                const posX = startX + (colIndex * (cellSize + gap));
                const posY = startY + (rowIndex * (cellSize + gap));

                if (currentWeek <= livedWeeks) {
                    ctx.fillStyle = state.lived;
                } else {
                    ctx.fillStyle = state.rest;
                }

                ctx.fillRect(posX, posY, cellSize, cellSize);
            }

            if (state.mode === 'image') {
                const dataUrl = els.canvas.toDataURL('image/png');
                els.fullRenderImg.src = dataUrl;
            }
        }

        function updateUrl() {
            const params = new URLSearchParams();
            params.set('dob', state.dob);
            params.set('years', state.years);
            params.set('bg', state.bg.replace('#', ''));
            params.set('lived', state.lived.replace('#', ''));
            params.set('rest', state.rest.replace('#', ''));
            params.set('layout', state.layout);

            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, '', newUrl);

            const directParams = new URLSearchParams(params);
            directParams.set('mode', 'image');
            els.directLink.href = `${window.location.pathname}?${directParams.toString()}`;
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `life-calendar-${state.dob}.png`;
            link.href = els.canvas.toDataURL('image/png');
            link.click();
        }

        function copyLink() {
            const url = window.location.href;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    alertCopy();
                }).catch(err => {
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alertCopy();
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        function alertCopy() {
            const btn = els.btnCopy;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Copied!';
            btn.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-green-50', 'text-green-700', 'border-green-200');
            }, 2000);
        }

        init();
    </script>
</body>

</html>